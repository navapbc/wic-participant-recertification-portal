# Staff Portal

## Overview

The staff portal is a [Lowdefy](https://lowdefy.com) that allows WIC staff to access the information and documents that participants submitted in the participant portal.

## Application Structure

The application files are:

- **`lowdefy.yaml`:** This is the application entrypoint for lowdefy. It defines important things like homepage, user, authentication, database connections, and pages.
- **`templates/page_template.yml`:** The pages on the staff portal all use the same template. It displays a header bar with logout button, and site titles
- **`pages/login.yml`:** The homepage. Only displays a login form. See [Authentication](#authentication).
- **`pages/recert.yml`:** The main page of the application. See [Recertification](#recertification).
- **`public/`:** Public static assets, like logos.

### Recertification

The staff portal operates by using a [lowdefy Knex connection](https://docs.lowdefy.com/Knex) to connect to the same postgresql database that the participant portal uses.

> Note: Under most production circumstances, two applications using the same database is _not_ a good idea and can lead to terrible race conditions. For our pilot, we determined that this was an acceptable choice because the staff portal only performed read-only operations on the database.

The [KnexRaw request](https://docs.lowdefy.com/connections-and-requests) runs a (somewhat complicated) sql query against the database to render the participant submissions. Generally, it queries: "Give me all submissions for the currently logged in user's WIC local agency and show them most recent to least recent".

#### Table: Ag Grid

The returned data is rendered using a [lowdefy Ag-Grid block](https://github.com/lowdefy/blocks-aggrid). All columns are resizable, some columns are sortable, and some columns are filterable. Click on the column header to sort the table by that column. Hover over the column header to reveal the filter button (an icon of three horizontal lines).

The data can be exported to CSV. [`valueGetters`](https://www.ag-grid.com/javascript-data-grid/value-getters/) are used to format the data for CSV (the "real" value of each cell) and [`cellRenderers`](https://www.ag-grid.com/javascript-data-grid/cell-rendering/) are used to format the data for the browser. Both `valueGetters` and `cellRenderers` are formatted using [`_nunjucks`](https://docs.lowdefy.com/_nunjucks) templates.

The submitted date is shown in the timezone of the browser.

#### Documents

Files that participants upload to the participant portal are saved in S3. The staff portal uses [presigned urls](https://docs.aws.amazon.com/AmazonS3/latest/userguide/using-presigned-url.html) to allow staff to access those documents. These urls are saved to the database by the participant portal and the staff portal retrieves them with the sql query.

> Note: In an ideal/production solution, these presigned S3 urls should be generated by lowdefy. Lowdefy does actually have support to [create presigned s3 urls](https://docs.lowdefy.com/AWSS3). However, lowdefy v3.23.3 does not support encrypted s3 buckets.

### Authentication

The staff portal is configured to use an OpenID Connect provider for [user authentication](https://docs.lowdefy.com/users-introduction). For our deployment, we used [AWS Cognito](https://aws.amazon.com/cognito). However, any [OpenID Connect provider](https://docs.lowdefy.com/openid-connect) will work. The authentication configuration is handled by:

- **Settings in `lowdefy.yml`**: Tells lowdefy which pages should require OpenID Connect authentication and the OpenID Connect scopes
- **Authentication secrets passed as environment variables:** Passes secrets such as the OpenID Connect client ID and secret to lowdefy. See `.env.example` for the secrets that need to be passed to lowdefy
- **Settings in your OpenID Connect provider:** You'll need to configure the allowed callback urls, allowed logout urls, etc.
- **Login flow in `login.yml`:** Renders a login block that redirects the user to the OpenID Connect provider and handles auto-redirect if a user is already logged in
- **Logout flow in `templates/page_template.yml`:** Renders a logout button that will log out the user when clicked. This button only renders if they are logged in.

> Note: Be sure to configure lowdefy and your OpenID Connect provider so that there is no  caching. Otherwise, a user that clicks log out will be successfully logged out, but when they click login again, they won't be prompted to re-authenticate. This should be handled by the lowdefy [`jwt.expiresIn`](https://docs.lowdefy.com/users-introduction) configuration setting. For security purposes, be sure to test this functionality operates as expected.

## Development & Deployment

### Docker

The application is intended to be deployed as a docker container The `Dockerfile` uses a multi-stage build strategy to flexibly build different images needed for different contexts:

- **`dev` image**: This image uses settings that assist in local development, including installing all development packages and running lowdefy in dev mode which will handle hot refreshing (`npx lowdefy dev`)
- **`prod` image**: This image uses a production-ready, stripped down version of the application that does not include development packages and uses a built version of the application run with node (`node ./dist/server.js`)

Files that docker builds should ignore are tracked in `.dockerignore`.

### Local Development

We recommend doing local development in a docker container as well. A `docker-compose.yml` file has been included for creating a container cluster that also starts supporting containers:

- **`lowdefy_dev`:** A development build of the app. This uses the `dev` docker image
- **`lowdefy_prod:`** A production build of the app. This uses the `prod` docker image and is included for final spot testing purposes
- **`postgres`:** A local postgresql database for development purposes. In production, this would be the actual live database that the participant portal writes data to.
- **`s3-local`:** A [minio](https://min.io) container used for local S3-like development
- **`createbuckets`:** An ephemeral container that will create the expected S3 buckets in minio. This container should stop when its done and not be long-running.
- **`remix`:** An ephemeral container that will seed the development database with some entries to test against. This container should stop when its done and not be long-running.

#### Usage

1. Make sure [docker](https://www.docker.com) is installed and running. We recommend using [Docker Desktop](https://www.docker.com/products/docker-desktop)
2. Run [`docker compose up --build --detach`](https://docs.docker.com/engine/reference/commandline/compose_up/). This command will build all of the docker images, start all of the containers, and then exit (leaving the containers running in the background).
  - Use `docker compose ps` to see the current status of the containers
  - Use `docker compose logs` to view all the docker logs
  - Use `docker compose exec <container name> sh` to execute a shell into any of the containers
  - See the [docker compose cli](https://docs.docker.com/compose/reference) documentation for more details
- Navigate to `localhost:3033` to view the `lowdefy_dev` app
- Run `docker compose down` to stop and remove all of the containers when you are done

### Testing (e2e)

The testing included with the staff portal is very limited. We have included infrastructure for running end-to-end (e2e) testing using [Playwright](https://playwright.dev). Example tests are located in `e2e/`. Playwright configuration is located in `playwright.config.ts`.

The participant portal includes much more robust end-to-end testing. The staff portal leverages the participant portal's e2e testing, including the `/participant/Dockerfile.playwright`.

Both the staff portal and the participant portal have an npm script in `package.json` that allows you to run `npm run e2e`. This will call the `/bin/run-e2e.sh` bash script in, which in turn will execute the `docker-compose.e2e.yml`.

Note: We chose to run playwright inside a docker container because we were experiencing significant pixel drift between snapshots taken on macOS vs snapshots taken in CI using Github Actions.

### Deployment

This repo includes CI/CD for the staff portal. The `Makefile` is used to support the CI/CD jobs in the `.github/workflows` directory.

## Customization

The staff portal was built for [Montana WIC](https://dphhs.mt.gov/ecfsd/WIC). To customize it for a different WIC state agency, change:

- [The name of the application](https://github.com/navapbc/wic-participant-recertification-portal/blob/0cb2893e3093d7b2f666367558ca6b4221d78e7e/staff/lowdefy.yaml#L4)
- [The page title in the template](https://github.com/navapbc/wic-participant-recertification-portal/blob/0cb2893e3093d7b2f666367558ca6b4221d78e7e/staff/templates/page_template.yml#L52)
- [The logo and alt text](https://github.com/navapbc/wic-participant-recertification-portal/blob/0cb2893e3093d7b2f666367558ca6b4221d78e7e/staff/templates/page_template.yml#L22)

## Lowdefy Reflections

For the pilot, we wanted to use a low-code tool to:

- Be as efficient with our time as possible
- Identify a tool that might save WIC state agencies time & money

We conducted technical research and chose the most affordable and promising tool: Lowdefy. By using lowdefy, we were able to quickly build a functional staff portal that allowed us to learn a lot. We still feel that building the staff portal as a separate application allows maximum flexibility. However, the single most useful feature would be if we were able to directly integrate with M-SPIRIT.

We donâ€™t recommend using Lowdefy at this time for a production staff portal because:

- It is not mature enough for scale
- The documentation is not fully developed
- It requires too many brittle dependencies