# Application Internals

This serves as a high-level overview of how the application is stitched together, and where
code lives for appropriate parts of the application.

## Database Overview

This application stores records for individuals related to a [`submissionID`](#submission) - a UUID v4 generated by the Remix application server, and returned to the client in a session cookie.

Read the [session section](#session) for more details about how the sessions work

### Common Fields

- createdAt - Timestamp for the creation of this record
- updatedAt - Timestamp for the last state change for this record

### Submission

- submissionId - The UUID for this participant's [Session](#session)
- localAgencyId - The foreign key to the [LocalAgency](#localagency) table
- submitted - Boolean flag if this form has been completed

### SubmissionForm

- submissionFormId - UUID for this record
- submissionId - UUID to the participant's [Session](#session)
- formRoute - The page route that originated this record; could be any string, but by convention is the name of the route
- formData - A JSONB blob for the data submitted on this `formRoute`

### LocalAgency

For more details about this table and how it works, see [Agencies](#agencies)

- localAgencyId - UUID for this record
- urlId - URL Part that uniquely identifies this agency
- name - Name of this WIC agency

### Document

- documentId - UUID for this Record
- submissionId - UUID for this participant's [Session](#session)
- s3Key - Location of this file in S3
- s3Url - Presigned GET URL for downloading this file (used by the staff portal)
- detectedFiletype - The MIME type for this file, as detected by the magic number in the first 2KB
- detectedFilesizeBytes - The content length of this file
- originalFilename - The filename the Input component detected when the Participant uploaded the file

### StaffUser

- staffUserId - The Unique UUID for this record, from AWS Cognito
- localAgencyId - The UUID for the [LocalAgency](#localagency)

## Session

Sessions are created by the code in [app/cookies.server.ts](../../participant/app/cookies.server.ts)

If an individual meets ONE of the following criteria, the session is not valid:

- The [Submission](#submission).submitted flag is set to `True`
- The [Submission](#submission).updatedAt timestamp is more than `MAX_SESSION_SECONDS` in the past
- The individual has no cookie
- The individual's [Submission](#submission).submissionId is not found in the database

The `MAX_SESSION_SECONDS` value is by default 1800 (30 minutes), and can be modified by setting the `MAX_SESSION_SECONDS` environment variable.

## Agencies

In order to associate submissions with specific WIC Agencies, we use part of the URL in combination with a database record in the [LocalAgency](#localagency) table.

The name for this pattern in Remix is called [Dynamic Segments](https://remix.run/docs/en/main/guides/routing#dynamic-segments)

You'll note that our routes are nested under `routes/$localAgency/recertify` - Remix allows us to access the value in `$localAgency` as an attribute of `params` for our functions. The function `validRoute` in [app/utils/redirect.ts](../../participant/app/utils/redirect.ts) looks up the value in `$localAgency` to ensure that it matches a [LocalAgency](#localagency) record in the database, using `LocalAgency.urlId`.

If this value _does not match_ a record in the database, the `validRoute` function returns a redirect URL to the first [LocalAgency](#localagency) record in the database.

Agencies are populated in the database in all environments using the [prisma/seed.ts](../../participant/prisma/seed.ts) code to create records from the data in [public/data/local-agencies.json](../../participant/public/data/local-agencies.json).

Updating the structured data in this JSON file will create / update agencies in the database.

## Internationalization

We use the community-provided Remix wrapper for [i18Next](https://www.i18next.com/) [remix-i18next](https://github.com/sergiodxa/remix-i18next)

This allows us to use lookup tables for our string values.

Note that only the translation strings for English, located at [public/locales/en/common.json](../../participant/public/locales/en/common.json) are complete.

Browsers may cache the contents of this JSON file. If you make a change to a string in this file and do not see updates, or see inconsistent browser updates, please clear your browser's cache or use an incognito/private browser window.

## Routing

### Remix Documentation

[Remix Routing](https://remix.run/docs/en/main/guides/routing)

### Routing Overview

Remix routing uses file-system semantics to map files as they're stored in the repository into URL paths in the application.

Not all pages are detailed here; please see the contents of the [/pages](./pages/) folder for more robust details about the form pages.

```bash
   |-- app
   |   |-- root.tsx
   |   |-- routes
   |   |   |-- $.tsx
   |   |   |-- $localAgency
   |   |   |   |-- recertify
   |   |   |   |   |-- $.tsx
   |   |   |   |   |-- about.tsx
   |   |   |   |   |-- changes.tsx
   |   |   |   |   |-- confirm.tsx
   |   |   |   |   |-- contact.tsx
   |   |   |   |   |-- count.tsx
   |   |   |   |   |-- details.tsx
   |   |   |   |   |-- index.tsx
   |   |   |   |   |-- name.tsx
   |   |   |   |   |-- review.tsx
   |   |   |   |   |-- upload.tsx
   |   |   |-- healthcheck.tsx
```

#### `root.tsx`

Root.tsx contains code that is loaded on every location in the Remix application.

We use `root.tsx` to set up internationalization, analytics, and to check that the `$localAgency` value in the current URL is valid.

#### `routes/`

The routes folder contains page locations.

This directory tree mirrors the routes in the application; creating a new file `routes/broccoli.tsx` would make `http://localhost:3000/broccoli` a valid URL in the application.

#### `routes/$.tsx`

This route is called a ["Splat"](https://remix.run/docs/en/main/guides/routing#splats) in Remix terminology. Essentially this will catch any non-existent value that isn't under a `$localAgency`, and reroute it to a valid URL, meaning that `http://localhost:3000/cauliflower` will redirect to `http://localhost:3000/gallatin/recertify`.

#### `routes/$localAgency/recertify`

This folder contains all of the form pages for the Participant Recertification Portal.

As mentioned above in [Agencies](#agencies), the `$localAgency` value becomes a parameter that we use to look up a [LocalAgency](#localagency) record. This then is used to create the [Submission](#submission)'s association with a [LocalAgency](#localagency).

This means that `http://localhost:3000/gallatin/recertify` and `http://localhost:3000/miles-city/recertify` both render the page at [routes/$localAgency/index.tsx](#routeslocalagencyindextsx)

#### `routes/$localAgency/index.tsx`

This is the landing page for the application.

For more details, see [./pages/00_index.md](./pages/00_index.md)

#### `routes/healthcheck.tsx`

This route returns a raw HTTP 200 if the application can reach the database, or a HTTP 500 if not.

We leverage this functionality both for Docker container health locally and for AWS Fargate container health status in deployment.
