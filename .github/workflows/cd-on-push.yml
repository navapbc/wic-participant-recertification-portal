name: ğŸ‘‰ Deploy on push

on:
  # !! Uncomment the following lines once you've set up the dev environment and ready to turn on continuous deployment
  push:
    branches: ["main", "PRP-166-cd-connect-the-infrastructure"]

jobs:
  check_participant:
    name: ğŸ” Check participant
    runs-on: ubuntu-latest
    outputs:
      has_modified: ${{ steps.modified-files-participant.outputs.any_modified }}
    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 2  # To retrieve the preceding commit

      - name: ğŸ—‚ Get modified files in the participant folder
        id: modified-files-participant
        uses: tj-actions/changed-files@v35
        with:
          files: participant

      - name: ğŸ“‹ List participant files that have been modified
        run: |
          echo "List all the files that have been modified: ${{ steps.modified-files-participant.outputs.all_modified_files }}"


  deploy_participant:
    name: ğŸ“¬ Deploy participant
    needs: check_participant
    if: ${{ needs.check_participant.outputs.has_modified  == 'true'}}
    uses: ./.github/workflows/cd.yml
    with:
      app_name: participant

  check_staff:
    name: ğŸ” Check staff
    runs-on: ubuntu-latest
    outputs:
      has_modified: ${{ steps.modified-files-staff.outputs.any_modified }}
    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 2  # To retrieve the preceding commit

      - name: ğŸ—‚ Get modified files in the staff_portal folder
        id: modified-files-staff
        uses: tj-actions/changed-files@v35
        with:
          files: staff_portal

      - name: ğŸ“‹ List staff_portal files that have been modified
        run: |
          echo "List all the files that have been modified: ${{ steps.modified-files-staff.outputs.all_modified_files }}"


  deploy_staff:
    name: ğŸ“¨ Deploy staff
    needs: check_staff
    if: ${{ needs.check_staff.outputs.has_modified  == 'true'}}
    uses: ./.github/workflows/cd.yml
    with:
      app_name: staff_portal

  check_analytics:
    name: ğŸ” Check analytics
    runs-on: ubuntu-latest
    outputs:
      has_modified: ${{ steps.modified-files-analytics.outputs.any_modified }}
    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 2  # To retrieve the preceding commit

      - name: ğŸ—‚ Get modified files in the analytics folder
        id: modified-files-analytics
        uses: tj-actions/changed-files@v35
        with:
          files: analytics

      - name: ğŸ“‹ List analytics files that have been modified
        run: |
          echo "List all the files that have been modified: ${{ steps.modified-files-analytics.outputs.all_modified_files }}"


  deploy_analytics:
    name: ğŸ“Š Deploy analytics
    needs: check_analytics
    if: ${{ needs.check_analytics.outputs.has_modified  == 'true'}}
    uses: ./.github/workflows/cd.yml
    with:
      app_name: analytics
