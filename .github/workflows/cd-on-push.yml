name: 👉 Deploy on push

on:
  # !! Uncomment the following lines once you've set up the dev environment and ready to turn on continuous deployment
  # push:
  #   branches: ["main"]
  # @DEBUG
  push:
    branches: ["PRP-166-cd-connect-the-infrastructure"]


jobs:
  check_participant:
    name: 🔎 Check participant
    runs-on: ubuntu-latest
    outputs:
      has_changed: ${{ steps.changed-files-participant.outputs.any_changed }}
    steps:
      - name: ⬇️ Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 2  # To retrieve the preceding commit

      - name: 🗂 Get changed files in the participant_portal folder
        id: changed-files-participant
        uses: tj-actions/changed-files@v35
        with:
          files: participant_portal

      - name: 📋 List participant_portal files that have changed
        run: |
          echo "List all the files that have changed: ${{ steps.changed-files-participant.outputs.all_changed_files }}"


  deploy_participant:
    name: 📬 Deploy participant
    needs: check_participant
    if: ${{ needs.check_participant.outputs.has_changed  == 'true'}}
    uses: ./.github/workflows/cd.yml
    with:
      app_name: participant_portal

  check_staff:
    name: 🔎 Check staff
    runs-on: ubuntu-latest
    outputs:
      has_changed: ${{ steps.changed-files-staff.outputs.any_changed }}
    steps:
      - name: ⬇️ Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 2  # To retrieve the preceding commit

      - name: 🗂 Get changed files in the staff_portal folder
        id: changed-files-staff
        uses: tj-actions/changed-files@v35
        with:
          files: staff_portal

      - name: 📋 List staff_portal files that have changed
        run: |
          echo "List all the files that have changed: ${{ steps.changed-files-staff.outputs.all_changed_files }}"


  deploy_staff:
    name: 📨 Deploy staff
    needs: check_staff
    if: ${{ needs.check_staff.outputs.has_changed  == 'true'}}
    uses: ./.github/workflows/cd.yml
    with:
      app_name: staff_portal

  check_analytics:
    name: 🔎 Check analytics
    runs-on: ubuntu-latest
    outputs:
      has_changed: ${{ steps.changed-files-analytics.outputs.any_changed }}
    steps:
      - name: ⬇️ Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 2  # To retrieve the preceding commit

      - name: 🗂 Get changed files in the analytics folder
        id: changed-files-analytics
        uses: tj-actions/changed-files@v35
        with:
          files: analytics

      - name: 📋 List analytics files that have changed
        run: |
          echo "List all the files that have changed: ${{ steps.changed-files-analytics.outputs.all_changed_files }}"


  deploy_analytics:
    name: 📊 Deploy analytics
    needs: check_analytics
    if: ${{ needs.check_analytics.outputs.has_changed  == 'true'}}
    uses: ./.github/workflows/cd.yml
    with:
      app_name: analytics
